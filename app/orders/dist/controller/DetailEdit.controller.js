var files=[];var idObjectPhoto="X",idObjectIdCard="X",idObjectLicense="X",idObjectSS="X",cont=0,fileNameDMS=undefined,folderDriver=undefined,fileExtension=undefined;var filePhoto=[],fileIdCard=[],fileLicense=[],fileSS=[];sap.ui.define(["./BaseController","sap/m/MessageToast","sap/m/MessageBox","sap/ui/core/Fragment","sap/ui/core/syncStyleClass"],function(e,t,i,a,s){"use strict";return e.extend("com.orders.orders.controller.DetailEdit",{onInit:function(){this.getRouter().getRoute("DetailEdit").attachPatternMatched(this._onMasterMatched,this);this.onDepartment()},onNavBack:function(){i.confirm(this.getView().getModel("i18n").getResourceBundle().getText("confirmCancelEditOrder"),{onClose:function(e){if(e==="OK"){this.getRouter().navTo("View1",{})}}.bind(this)})},_onMasterMatched:function(e){var t=e.getParameter("arguments").invoicePathEdit;var i;var a=this;jQuery.ajax({url:"/catalog/CargoOrders?$filter=ID eq "+t,type:"GET",dataType:"json",success:function(e){console.log(e.value);console.log(e);i=e.value;a.fnAjax("City",i[0].city_route_code,"code","_IDGenComboBox2");a.fnAjax("Department",i[0].department_route_code,"code","_IDGenComboBox1");a.getView().byId("idCargoDate").setValue(i[0].cargo_date);a.getView().byId("_IDGenComboBox1").setValue(i[0].department_route_code);a.getView().byId("_IDGenComboBox2").setValue(i[0].city_route_code);a.getView().byId("idVehiclePlate").setValue(i[0].vehicle_plate);a.getView().byId("idTrailer").setValue(i[0].trailer);a.getView().byId("idCapacity").setValue(i[0].capacity);a.getView().byId("idCard").setValue(i[0].id_card);a.getView().byId("idDriverName").setValue(i[0].driver_name);a.getView().byId("idDriverLastName").setValue(i[0].driver_last_name);a.getView().byId("idCellPhoneNumber").setValue(i[0].cell_phone_number);a.getView().byId("idDrivingLicense").setValue(i[0].driving_license);a.getView().byId("idTextAreaRemarks").setValue(i[0].remarks);a.getView().byId("_IDGenText12").setText(i[0].ID)},error:function(e,t,i){sap.ui.commons.MessageBox.alert("Failed to retrieve data: "+t+"\n"+i)}})},fnAjax:async function(e,t,a,s){var r=this;var o="/catalog/"+e+"?$filter="+a+" eq "+t;jQuery.ajax({url:o,type:"GET",dataType:"json",success:function(e){console.log(e);r.getView().byId(s).setValue(e.value[0].description)},error:function(e,t,a){i.alert("Failed to retrieve data: "+t+"\n"+a)}})},getRouter:function(){return this.getOwnerComponent().getRouter()},pressDelete:function(e){var t=e.getParameter("id").split("--");switch(t[2]){case"photoDelete":{idObjectPhoto="";this.getView().byId("photoFileUploaderId").setVisible(true);break}case"pdfIDCardDelete":{idObjectIdCard="";this.getView().byId("idCardFileUploaderId").setVisible(true);break}case"pdfLicenseDelete":{idObjectLicense="";this.getView().byId("licenseFileUploaderId").setVisible(true);break}case"pdfSsDelete":{idObjectSS="";this.getView().byId("ssFileUploaderId").setVisible(true);break}default:{}}if(t!==""){this.getView().byId(t[2]).setVisible(false)}},rebindTable:function(e,t){var i=sap.ui.getCore().DataModel.byId("table");i.bindItems({path:"/CargoOrders",template:e,templateShareable:true}).setKeyboardMode(t)},onInputChange:function(){this.refreshModel("")},refreshModel:function(e,t){return new Promise((i,a)=>{this.makeChangesAndSubmit.call(this,i,a,e,t)})},makeChangesAndSubmit:function(e,i,a,s){const r=this;a="";s="$auto";if(r.getView().getModel().hasPendingChanges(s)){r.getView().getModel().submitBatch(s).then(o=>{r.makeChangesAndSubmit(e,i,a,s);t.show("Record updated Successfully")},i).catch(function e(i){t.show("Something Went Wrong ",i.message)})}else{r.getView().getModel(a).refresh(s);e()}},onUpload:function(e){var t=e.getParameter("id").split("--");switch(t[2]){case"photoFileUploaderId":{filePhoto=e.getParameter("files")[0];cont+=1;this.getView().byId("photoDelete").setVisible(true);this.getView().byId("photoFileUploaderId").setVisible(false);break}case"idCardFileUploaderId":{fileIdCard=e.getParameter("files")[0];cont+=1;this.getView().byId("pdfIDCardDelete").setVisible(true);this.getView().byId("idCardFileUploaderId").setVisible(false);break}case"licenseFileUploaderId":{fileLicense=e.getParameter("files")[0];cont+=1;this.getView().byId("pdfLicenseDelete").setVisible(true);this.getView().byId("licenseFileUploaderId").setVisible(false);break}case"ssFileUploaderId":{fileSS=e.getParameter("files")[0];cont+=1;this.getView().byId("pdfSsDelete").setVisible(true);this.getView().byId("ssFileUploaderId").setVisible(false);break}default:{}}},fnexecuteUpload:function(e,t){var e=e;var t=t;if(filePhoto.size>0){folderDriver="Fotos";fileExtension=".jpg";this.fnPostAJax().then(i=>this.fnpostDoc(i,filePhoto,"Fotos",".jpg",e,t))}if(fileIdCard.size>0){folderDriver="Documento identidad";fileExtension=".pdf";this.fnPostAJax().then(t=>this.fnpostDoc(t,fileIdCard,"Documento identidad",".pdf",e))}if(fileLicense.size>0){folderDriver="Licencia conduccion";fileExtension=".pdf";this.fnPostAJax().then(t=>this.fnpostDoc(t,fileLicense,"Licencia conduccion",".pdf",e))}if(fileSS.size>0){folderDriver="Seguridad social";fileExtension=".pdf";this.fnPostAJax().then(t=>this.fnpostDoc(t,fileSS,"Seguridad social",".pdf",e))}},fnPostAJax:async function(){let e;try{e=await $.ajax({url:"https://dev-paperless.authentication.us10.hana.ondemand.com/oauth/token?grant_type=client_credentials",type:"POST",headers:{Authorization:"Basic c2ItNmIzYjEyYmItNDE1NS00MTBkLTljMTktNDE4NGU4NWExMWIxIWI5ODA3NHxzZG0tZGktRG9jdW1lbnRNYW5hZ2VtZW50LXNkbV9pbnRlZ3JhdGlvbiFiNjMzMjoyVGpyTTZoaVVxMnZ3K0pTUm0yaHlCa1FJTmM9"}});return e}catch(e){console.log(e)}},fnGetAJax:async function(e){let t;var e=e;var i="/catalog/CargoOrders?$filter=ID eq "+e;try{t=await $.ajax({url:i,type:"GET"});return t}catch(e){console.log(e)}},fnpostDoc:async function(e,t,i,a,s,r){console.log(e);var s=s;var r=r;var o=e.token_type;var d=e.access_token;var n=o+" "+d;let l;var i=i;var c=a;var u=new FormData;u.append("cmisaction","createDocument");u.append("filename",t.name);u.append("_charset","UTF-8");u.append("propertyId[0]","cmis:name");u.append("propertyValue[0]",fileNameDMS+c);u.append("propertyId[1]","cmis:objectTypeId");u.append("propertyValue[1]","cmis:document");u.append("succinct","true");u.append("includeAllowableActions","true");u.append("media",t,t.name);var g={method:"POST",headers:{Authorization:n},body:u,redirect:"follow"};try{l=await fetch("https://api-sdm-di.cfapps.us10.hana.ondemand.com/browser/50ede09e-1659-4900-bf1d-fdb8b8adb8d3/root/Documentos Orden de Cargue/Conductores/"+i,g).then(e=>e.text()).then(e=>{var t=e.split(":");var a=t[2];var r=t[3].split(",");var o=r[0].replace(/['"]+/g,"");console.log(o);switch(i){case"Fotos":{this.onOpenDialog();idObjectPhoto=o;this.fnGetAJax(s).then(e=>this.onPut(e,s,"Fotos",o));break}case"Documento identidad":{idObjectIdCard=o;this.fnGetAJax(s).then(e=>this.onPut(e,s,"Documento identidad",o));break}case"Licencia conduccion":{idObjectLicense=o;this.fnGetAJax(s).then(e=>this.onPut(e,s,"Licencia conduccion",o));break}case"Seguridad social":{idObjectSS=o;this.fnGetAJax(s).then(e=>this.onPut(e,s,"Seguridad social",o));break}default:{}}i=""})}catch(e){console.log(e)}},onPut:function(e,t,i,a){var s="/catalog/CargoOrders("+t+")";var r=r;var i=i;var e=e;var o=this;if(e.value.length!=0){r=e.value[0];if(i=="Fotos"){r.driver_photo=a;idObjectPhoto=a}if(i=="Documento identidad"){r.pdf_id_card=a;idObjectIdCard=a}if(i=="Licencia conduccion"){r.pdf_license=a;idObjectLicense=a}if(i=="Seguridad social"){r.pdf_social_security=a;idObjectSS=a}r.driver_photo=idObjectPhoto;r.pdf_id_card=idObjectIdCard;r.pdf_license=idObjectLicense;r.pdf_social_security=idObjectSS;$.ajax({type:"PUT",url:s,contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(r),success:function(e,t,i){console.log(e)},error:function(e,t,i){var a=[];console.log(JSON.stringify(e))}})}else{}},onOpenDialog:function(){if(!this._pBusyDialog){this._pBusyDialog=a.load({name:"com.project.project1.fragment.popup",BaseController:this}).then(function(e){this.getView().addDependent(e);s("sapUiSizeCompact",this.getView(),e);return e}.bind(this))}this._pBusyDialog.then(function(e){e.open();this.simulateServerRequest()}.bind(this))},simulateServerRequest:function(){iTimeoutId=setTimeout(function(){this._pBusyDialog.then(function(e){e.close()})}.bind(this),5e3)},onDialogClosed:function(e){clearTimeout(iTimeoutId);if(e.getParameter("cancelPressed")){}else{t.show(this.getView().getModel("i18n").getResourceBundle().getText("confirmSaveEditOrder"));this.getRouter().navTo("View1",{})}},onSave:function(){var e=this.onChange();var a=this;if(idObjectPhoto==""){i.error(this.getView().getModel("i18n").getResourceBundle().getText("errorUploadPhoto"));e=false}if(idObjectIdCard==""){i.error(this.getView().getModel("i18n").getResourceBundle().getText("errorUploadIdCard"));e=false}
// if (fileLicense <= 0) {
if(idObjectLicense==""){i.error(this.getView().getModel("i18n").getResourceBundle().getText("errorUploadLicense"));e=false}if(idObjectSS==""){i.error(this.getView().getModel("i18n").getResourceBundle().getText("errorUploadSS"));e=false}if(e===true){i.confirm(this.getView().getModel("i18n").getResourceBundle().getText("confirmEditOrder"),{onClose:function(e){if(e==="OK"){fileNameDMS=this.byId("idCard").getValue();var t={vehicle_plate:this.byId("idVehiclePlate").getValue(),trailer:this.byId("idTrailer").getValue(),id_card:this.byId("idCard").getValue(),driver_name:this.byId("idDriverName").getValue(),driver_last_name:this.byId("idDriverLastName").getValue(),cell_phone_number:this.byId("idCellPhoneNumber").getValue(),driving_license:this.byId("idDrivingLicense").getValue(),remarks:this.byId("idTextAreaRemarks").getValue(),driver_photo:idObjectPhoto,pdf_id_card:idObjectIdCard,pdf_license:idObjectLicense,pdf_social_security:idObjectSS};console.log(t);var i;var a=this;var s=this.byId("_IDGenText12").getText();var r="/catalog/CargoOrders("+s+")";var o="/catalog/CargoOrders?$filter=ID eq "+s;$.ajax({type:"PUT",url:r,contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(t),success:function(e,s,r){console.log(e);a.fnexecuteUpload(e.ID,t);jQuery.ajax({url:o,type:"GET",dataType:"json",success:function(e){console.log(e.value);console.log(e);i=e.value;a.getView().byId("idCargoDate").setValue(i[0].cargo_date);a.getView().byId("_IDGenComboBox1").setValue(i[0].department_route_code);a.getView().byId("_IDGenComboBox2").setValue(i[0].city_route_code);a.getView().byId("idVehiclePlate").setValue(i[0].vehicle_plate);a.getView().byId("idTrailer").setValue(i[0].trailer);a.getView().byId("idCapacity").setValue(i[0].capacity);a.getView().byId("idCard").setValue(i[0].id_card);a.getView().byId("idDriverName").setValue(i[0].driver_name);a.getView().byId("idDriverLastName").setValue(i[0].driver_last_name);a.getView().byId("idCellPhoneNumber").setValue(i[0].cell_phone_number);a.getView().byId("idDrivingLicense").setValue(i[0].driving_license);a.getView().byId("idTextAreaRemarks").setValue(i[0].remarks)},error:function(e,t,i){sap.ui.commons.MessageBox.alert("Failed to retrieve data: "+t+"\n"+i)}})},error:function(e,t,i){var a=[];console.log(JSON.stringify(e))}})}}.bind(this)})}else{t.show(this.getView().getModel("i18n").getResourceBundle().getText("blackFields"))}},onChange:function(){var e=true;var t=this.getView().byId("idCargoDate").getValue();var i=this.byId("_IDGenComboBox1").getValue();var a=this.byId("_IDGenComboBox2").getValue();var s=this.byId("idVehiclePlate").getValue();var r=this.byId("idTrailer").getValue();var o=this.byId("idCapacity").getValue();var d=this.byId("idCard").getValue();var n=this.byId("idDriverName").getValue();var l=this.byId("idDriverLastName").getValue();var c=this.byId("idCellPhoneNumber").getValue();var u=this.byId("idDrivingLicense").getValue();if(t==""){this.getView().byId("idCargoDate").setValueState("Error");e=false}else{this.getView().byId("idCargoDate").setValueState("Success")}if(i==""){this.getView().byId("_IDGenComboBox1").setValueState("Error");e=false}else{this.getView().byId("_IDGenComboBox1").setValueState("Success")}if(a==""){this.getView().byId("_IDGenComboBox2").setValueState("Error");e=false}else{this.getView().byId("_IDGenComboBox2").setValueState("Success")}if(s==""){this.getView().byId("idVehiclePlate").setValueState("Error");e=false}else{this.getView().byId("idVehiclePlate").setValueState("Success")}if(r==""){this.getView().byId("idTrailer").setValueState("Error");e=false}else{this.getView().byId("idTrailer").setValueState("Success")}if(o==""){this.getView().byId("idCapacity").setValueState("Error");e=false}else{this.getView().byId("idCapacity").setValueState("Success")}if(d==""){this.getView().byId("idCard").setValueState("Error");e=false}else{this.getView().byId("idCard").setValueState("Success")}if(n==""){this.getView().byId("idDriverName").setValueState("Error");e=false}else{this.getView().byId("idDriverName").setValueState("Success")}if(l==""){this.getView().byId("idDriverLastName").setValueState("Error");e=false}else{this.getView().byId("idDriverLastName").setValueState("Success")}if(c==""){this.getView().byId("idCellPhoneNumber").setValueState("Error");e=false}else{this.getView().byId("idCellPhoneNumber").setValueState("Success")}if(u==""){this.getView().byId("idDrivingLicense").setValueState("Error");e=false}else{this.getView().byId("idDrivingLicense").setValueState("Success")}return e},onDepartment:function(e){var t=new sap.ui.model.json.JSONModel;var a={ListModelDepartment:[{}]};var s=this.getView().byId("_IDGenComboBox1");jQuery.ajax({url:"/catalog/Department",type:"GET",dataType:"json",success:function(e){console.log(e);t.setData(e.value);a.ListModelDepartment=e.value;t.setData(a);console.log(a);s.setModel(t)},error:function(e,t,a){i.alert(this.getView().getModel("i18n").getResourceBundle().getText("errorHelpValueDepartment"),+": "+t+"\n"+a)}})},onCity:function(e){var t=e.getSource(),a=t.getSelectedKey(),s=t.getValue();var r="/catalog/City?$filter=department_code eq "+a;var o=new sap.ui.model.json.JSONModel;var d={ListModelCity:[{}]};var n=this.getView().byId("_IDGenComboBox2");jQuery.ajax({url:r,type:"GET",dataType:"json",success:function(e){console.log(e);o.setData(e.value);d.ListModelCity=e.value;o.setData(d);console.log(d);n.setModel(o)},error:function(e,t,a){i.alert("Failed to retrieve data: "+t+"\n"+a)}})}})});