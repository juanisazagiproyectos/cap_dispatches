var files=[];var idObjectPhoto=undefined,idObjectIdCard=undefined,idObjectLicense=undefined,idObjectSS=undefined,cont=0,fileNameDMS=undefined,folderDriver=undefined,fileExtension=undefined;var filePhoto=[],fileIdCard=[],fileLicense=[],fileSS=[];sap.ui.define(["./BaseController","sap/m/MessageToast","sap/m/MessageBox","sap/ui/core/Fragment","sap/ui/core/syncStyleClass","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","../model/formatter"],function(e,t,i,a,s,o,r,d){"use strict";var n;return e.extend("com.orders.orders.controller.DetailCreate",{onInit:function(){this.getRouter().getRoute("DetailCreate").attachPatternMatched(this._onObjectMatched,this);this.onDepartment();var e=new sap.ui.model.json.JSONModel;var t={ListModelDepartment:[{}]};var i=this.getView().byId("_IDGenComboBox1");console.log(t);i.setModel(e);var e=new sap.ui.model.json.JSONModel;var a={ListModelCity:[{}]};i=this.getView().byId("_IDGenComboBox2");e.setData(a);console.log(a);i.setModel(e)},onNavBack:function(){var e=r.getInstance().getPreviousHash();if(e!==undefined){history.go(-1)}else{this.getRouter().navTo("worklist",{},true)}},_onMasterMatched:function(){},getRouter:function(){return this.getOwnerComponent().getRouter()},onCancel:function(){i.confirm(this.getView().getModel("i18n").getResourceBundle().getText("confirmCancelCreateOrder"),{onClose:function(e){if(e==="OK"){this.getRouter().navTo("worklist",{})}}.bind(this)})},pressDelete:function(e){var t=e.getParameter("id").split("--");switch(t[2]){case"photoDelete":{idObjectPhoto="";this.getView().byId("photoFileUploaderId").setVisible(true);break}case"pdfIDCardDelete":{idObjectIdCard="";this.getView().byId("idCardFileUploaderId").setVisible(true);break}case"pdfLicenseDelete":{idObjectLicense="";this.getView().byId("licenseFileUploaderId").setVisible(true);break}case"pdfSsDelete":{idObjectSS="";this.getView().byId("ssFileUploaderId").setVisible(true);break}default:{}}if(t!==""){this.getView().byId(t[2]).setVisible(false)}},onUpload:function(e){debugger;var t=e.getParameter("id").split("--");switch(t[2]){case"photoFileUploaderId":{filePhoto=e.getParameter("files")[0];cont+=1;this.getView().byId("photoDelete").setVisible(true);this.getView().byId("photoFileUploaderId").setVisible(false);break}case"idCardFileUploaderId":{fileIdCard=e.getParameter("files")[0];cont+=1;this.getView().byId("pdfIDCardDelete").setVisible(true);this.getView().byId("idCardFileUploaderId").setVisible(false);break}case"licenseFileUploaderId":{fileLicense=e.getParameter("files")[0];cont+=1;this.getView().byId("pdfLicenseDelete").setVisible(true);this.getView().byId("licenseFileUploaderId").setVisible(false);break}case"ssFileUploaderId":{fileSS=e.getParameter("files")[0];cont+=1;this.getView().byId("pdfSsDelete").setVisible(true);this.getView().byId("ssFileUploaderId").setVisible(false);break}default:{}}},fnexecuteUpload:function(e,t){var e=e;var t=t;if(filePhoto.size>0){folderDriver="Fotos";fileExtension=".jpg";this.fnPostAJax().then(i=>this.fnpostDoc(i,filePhoto,"Fotos",".jpg",e,t))}if(fileIdCard.size>0){folderDriver="Documento identidad";fileExtension=".pdf";this.fnPostAJax().then(t=>this.fnpostDoc(t,fileIdCard,"Documento identidad",".pdf",e))}if(fileLicense.size>0){folderDriver="Licencia conduccion";fileExtension=".pdf";this.fnPostAJax().then(t=>this.fnpostDoc(t,fileLicense,"Licencia conduccion",".pdf",e))}if(fileSS.size>0){folderDriver="Seguridad social";fileExtension=".pdf";this.fnPostAJax().then(t=>this.fnpostDoc(t,fileSS,"Seguridad social",".pdf",e))}},fnPostAJax:async function(){let e;try{e=await $.ajax({url:"https://dev-paperless.authentication.us10.hana.ondemand.com/oauth/token?grant_type=client_credentials",type:"POST",headers:{Authorization:"Basic c2ItNmIzYjEyYmItNDE1NS00MTBkLTljMTktNDE4NGU4NWExMWIxIWI5ODA3NHxzZG0tZGktRG9jdW1lbnRNYW5hZ2VtZW50LXNkbV9pbnRlZ3JhdGlvbiFiNjMzMjoyVGpyTTZoaVVxMnZ3K0pTUm0yaHlCa1FJTmM9"}});return e}catch(e){console.log(e)}},fnGetAJax:async function(e){let t;var e=e;var i="/catalog/CargoOrders?$filter=ID eq "+e;try{t=await $.ajax({url:i,type:"GET"});return t}catch(e){console.log(e)}},fnpostDoc:async function(e,t,i,a,s,o){console.log(e);var s=s;var o=o;var r=e.token_type;var d=e.access_token;var n=r+" "+d;let l;var i=i;var c=a;var u=new FormData;u.append("cmisaction","createDocument");u.append("filename",t.name);u.append("_charset","UTF-8");u.append("propertyId[0]","cmis:name");u.append("propertyValue[0]",fileNameDMS+c);u.append("propertyId[1]","cmis:objectTypeId");u.append("propertyValue[1]","cmis:document");u.append("succinct","true");u.append("includeAllowableActions","true");u.append("media",t,t.name);var f={method:"POST",headers:{Authorization:n},body:u,redirect:"follow"};try{l=await fetch("https://api-sdm-di.cfapps.us10.hana.ondemand.com/browser/50ede09e-1659-4900-bf1d-fdb8b8adb8d3/root/Documentos Orden de Cargue/Conductores/"+i,f).then(e=>e.text()).then(e=>{var t=e.split(":");var a=t[2];var o=t[3].split(",");var r=o[0].replace(/['"]+/g,"");console.log(r);switch(i){case"Fotos":{this.onOpenDialog();idObjectPhoto=r;this.fnGetAJax(s).then(e=>this.onPut(e,s,"Fotos",r));break}case"Documento identidad":{idObjectIdCard=r;this.fnGetAJax(s).then(e=>this.onPut(e,s,"Documento identidad",r));break}case"Licencia conduccion":{idObjectLicense=r;this.fnGetAJax(s).then(e=>this.onPut(e,s,"Licencia conduccion",r));break}case"Seguridad social":{idObjectSS=r;this.fnGetAJax(s).then(e=>this.onPut(e,s,"Seguridad social",r));break}default:{}}i=""})}catch(e){console.log(e)}},onPut:function(e,t,i,a){var s="/catalog/CargoOrders("+t+")";var o=o;var i=i;var e=e;var r=this;if(e.value.length!=0){o=e.value[0];if(i=="Fotos"){o.driver_photo=a;idObjectPhoto=a}if(i=="Documento identidad"){o.pdf_id_card=a;idObjectIdCard=a}if(i=="Licencia conduccion"){o.pdf_license=a;idObjectLicense=a}if(i=="Seguridad social"){o.pdf_social_security=a;idObjectSS=a}o.driver_photo=idObjectPhoto;o.pdf_id_card=idObjectIdCard;o.pdf_license=idObjectLicense;o.pdf_social_security=idObjectSS;$.ajax({type:"PUT",url:s,contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(o),success:function(e,t,i){console.log(e)},error:function(e,t,i){var a=[];console.log(JSON.stringify(e))}})}else{}},onOpenDialog:function(){if(!this._pBusyDialog){this._pBusyDialog=a.load({name:"com.orders.orders.fragment.popup",BaseController:this}).then(function(e){this.getView().addDependent(e);s("sapUiSizeCompact",this.getView(),e);return e}.bind(this))}this._pBusyDialog.then(function(e){e.open();this.simulateServerRequest()}.bind(this))},simulateServerRequest:function(){n=setTimeout(function(){this._pBusyDialog.then(function(e){e.close()})}.bind(this),1e4)},onDialogClosed:function(e){clearTimeout(n);if(e.getParameter("cancelPressed")){}else{t.show(this.getView().getModel("i18n").getResourceBundle().getText("newOrder"));this.getRouter().navTo("Worklist",{})}},onCreate:function(){var e=this.onChange();var a=this;if(filePhoto<=0){i.error(this.getView().getModel("i18n").getResourceBundle().getText("errorUploadPhoto"));e=false}if(fileIdCard<=0){i.error(this.getView().getModel("i18n").getResourceBundle().getText("errorUploadIdCard"));e=false}if(fileLicense<=0){i.error(this.getView().getModel("i18n").getResourceBundle().getText("errorUploadLicense"));e=false}if(fileSS<=0){i.error(this.getView().getModel("i18n").getResourceBundle().getText("errorUploadSS"));e=false}if(e===true){i.confirm(this.getView().getModel("i18n").getResourceBundle().getText("confirmCreateOrder"),{onClose:function(e){if(e==="OK"){var t=20;fileNameDMS=a.byId("idCard").getValue();
// if (idObjectLicense === "") {
//     MessageBox.error(this.getView().getModel("i18n").getResourceBundle().getText("errorUploadLicense"));
debugger;var i={status_order:"Pendiente",vehicle_plate:a.byId("idVehiclePlate").getValue(),trailer:a.byId("idTrailer").getValue(),id_card:a.byId("idCard").getValue(),driver_name:a.byId("idDriverName").getValue(),driver_last_name:a.byId("idDriverLastName").getValue(),cell_phone_number:a.byId("idCellPhoneNumber").getValue(),driving_license:a.byId("idDrivingLicense").getValue(),remarks:a.byId("idTextAreaRemarks").getValue(),driver_photo:"",pdf_id_card:"",pdf_license:"",pdf_social_security:""};$.ajax({type:"POST",url:"/catalog/CargoOrders",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(i),success:function(e,t,s){console.log(e);a.fnexecuteUpload(e.ID,i)},error:function(e,t,i){var a=[];console.log(JSON.stringify(e))}})}}.bind(this)})}else{t.show(this.getView().getModel("i18n").getResourceBundle().getText("blackFields"))}},onChange:function(){var e=true;var t=this.getView().byId("idCargoDate").getValue();var i=this.byId("_IDGenComboBox1").getValue();var a=this.byId("_IDGenComboBox2").getValue();var s=this.byId("idVehiclePlate").getValue();var o=this.byId("idTrailer").getValue();var r=this.byId("idCapacity").getValue();var d=this.byId("idCard").getValue();var n=this.byId("idDriverName").getValue();var l=this.byId("idDriverLastName").getValue();var c=this.byId("idCellPhoneNumber").getValue();var u=this.byId("idDrivingLicense").getValue();if(t==""){this.getView().byId("idCargoDate").setValueState("Error");e=false}else{this.getView().byId("idCargoDate").setValueState("Success")}if(i==""){this.getView().byId("_IDGenComboBox1").setValueState("Error");e=false}else{this.getView().byId("_IDGenComboBox1").setValueState("Success")}if(a==""){this.getView().byId("_IDGenComboBox2").setValueState("Error");e=false}else{this.getView().byId("_IDGenComboBox2").setValueState("Success")}if(s==""){this.getView().byId("idVehiclePlate").setValueState("Error");e=false}else{this.getView().byId("idVehiclePlate").setValueState("Success")}if(o==""){this.getView().byId("idTrailer").setValueState("Error");e=false}else{this.getView().byId("idTrailer").setValueState("Success")}if(r==""){this.getView().byId("idCapacity").setValueState("Error");e=false}else{this.getView().byId("idCapacity").setValueState("Success")}if(d==""){this.getView().byId("idCard").setValueState("Error");e=false}else{this.getView().byId("idCard").setValueState("Success")}if(n==""){this.getView().byId("idDriverName").setValueState("Error");e=false}else{this.getView().byId("idDriverName").setValueState("Success")}if(l==""){this.getView().byId("idDriverLastName").setValueState("Error");e=false}else{this.getView().byId("idDriverLastName").setValueState("Success")}if(c==""){this.getView().byId("idCellPhoneNumber").setValueState("Error");e=false}else{this.getView().byId("idCellPhoneNumber").setValueState("Success")}if(u==""){this.getView().byId("idDrivingLicense").setValueState("Error");e=false}else{this.getView().byId("idDrivingLicense").setValueState("Success")}return e},onDepartment:function(e){var t=new sap.ui.model.json.JSONModel;var a={ListModelDepartment:[{}]};var s=this.getView().byId("_IDGenComboBox1");jQuery.ajax({url:"/catalog/Department",type:"GET",dataType:"json",success:function(e){console.log(e);t.setData(e.value);a.ListModelDepartment=e.value;t.setData(a);console.log(a);s.setModel(t)},error:function(e,t,a){i.alert(this.getView().getModel("i18n").getResourceBundle().getText("errorHelpValueDepartment"),+": "+t+"\n"+a)}})},onCity:function(e){var t=e.getSource(),a=t.getSelectedKey(),s=t.getValue();var o="/catalog/City?$filter=department_code eq "+a;debugger;var r=new sap.ui.model.json.JSONModel;var d={ListModelCity:[{}]};var n=this.getView().byId("_IDGenComboBox2");jQuery.ajax({url:o,type:"GET",dataType:"json",success:function(e){console.log(e);r.setData(e.value);d.ListModelCity=e.value;r.setData(d);console.log(d);n.setModel(r)},error:function(e,t,a){i.alert("Failed to retrieve data: "+t+"\n"+a)}})}})});